
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tráfego Orgânico Emagrecentro — Instagram</title>
<style>
:root{--card:#0c1b28;--accent:#00b4db;--muted:#9fb0c1;--glass: rgba(255,255,255,0.03);}
body{margin:0;font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif;background:linear-gradient(90deg,#02101a 0%, #061827 100%);color:#e6f0f6}
.header{display:flex;align-items:center;justify-content:space-between;padding:18px 28px}
.brand{display:flex;align-items:center;gap:12px}
.brand img{height:44px}
.title{font-size:18px;font-weight:700}
.controls{display:flex;gap:10px;align-items:center}
.select, .btn, .input{background:var(--card);border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:8px 10px;border-radius:6px}
.container{padding:18px 28px}
.kpis{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:18px}
.card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.4);flex:1;min-width:200px}
.row{display:flex;gap:12px}
.main{display:grid;grid-template-columns:2fr 1fr;gap:14px}
.chart{height:420px;background:var(--card);border-radius:10px;padding:12px}
.side .small{height:200px;margin-bottom:12px}
.tableWrap{margin-top:18px;background:var(--card);border-radius:10px;padding:12px}
table{width:100%;border-collapse:collapse;color:#d9eefc}
th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.02)}
.footer{padding:12px 28px;color:var(--muted);font-size:13px}
@media(max-width:900px){.main{grid-template-columns:1fr}.kpis{flex-direction:column} .header{flex-direction:column;align-items:flex-start;gap:12px}}
</style>
</head>
<body>
<header class="header">
  <div class="brand">
    <img id="logo" src="assets/logo.jfif" alt="Emagrecentro logo" onerror="this.style.display='none'">
    <div>
      <div class="title">Tráfego Orgânico Emagrecentro — Instagram</div>
      <div style="color:var(--muted);font-size:13px">Conectada ao Google Sheets (CSV público)</div>
    </div>
  </div>
  <div class="controls">
    <label style="color:var(--muted);font-size:13px">Unidade:</label>
    <select id="unitSelect" class="select"><option>Todas</option></select>
    <label style="color:var(--muted);font-size:13px">Período:</label>
    <input id="from" class="input" type="date">
    <input id="to" class="input" type="date">
    <button id="refreshBtn" class="btn">Atualizar</button>
  </div>
</header>

<main class="container">
  <section class="kpis" id="kpis">
    <div class="card"><div style="color:var(--muted);font-size:13px">Direct Enviado</div><div id="k_direct" style="font-size:22px;font-weight:700">-</div></div>
    <div class="card"><div style="color:var(--muted);font-size:13px">Respondeu</div><div id="k_resp" style="font-size:22px;font-weight:700">-</div></div>
    <div class="card"><div style="color:var(--muted);font-size:13px">Agendou</div><div id="k_agend" style="font-size:22px;font-weight:700">-</div></div>
    <div class="card"><div style="color:var(--muted);font-size:13px">Compareceu</div><div id="k_comp" style="font-size:22px;font-weight:700">-</div></div>
    <div class="card"><div style="color:var(--muted);font-size:13px">Comprou</div><div id="k_buy" style="font-size:22px;font-weight:700">-</div></div>
  </section>

  <section class="main">
    <div class="chart card" id="chartArea">
      <div style="color:var(--muted);margin-bottom:8px">Evolução diária (últimos 30 dias)</div>
      <canvas id="evolChart" style="width:100%;height:360px"></canvas>
    </div>

    <aside class="side">
      <div class="card small" id="funnelArea"><div style="color:var(--muted);margin-bottom:8px">Funil</div><canvas id="funnelChart" style="width:100%;height:160px"></canvas></div>
      <div class="card small" id="pieArea"><div style="color:var(--muted);margin-bottom:8px">Conversão</div><canvas id="pieChart" style="width:100%;height:160px"></canvas></div>
      <div class="card small"><div style="color:var(--muted);margin-bottom:8px">Previsão (7 dias)</div><div id="forecast" style="font-weight:700;margin-top:10px">-</div></div>
    </aside>
  </section>

  <section class="tableWrap card">
    <div style="color:var(--muted);margin-bottom:8px">Tabela (últimos 500 registros)</div>
    <div style="overflow:auto;max-height:360px">
      <table id="dataTable"><thead><tr>
        <th>Data</th><th>Unidade</th><th>Direct Enviado</th><th>Respondeu</th><th>Agendou</th><th>Compareceu</th><th>Comprou</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>

  <div class="footer">Dashboard criada para Emagrecentro — atualize os dados na aba <b>Leads</b> do Google Sheets.</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSjDEbxS9ieNObM4lVDYcZ_E9tzuDvf92I8e0VEJCrkByw2r9gHUiUsWWGkE65J97dkiO0Ind8GEoju/pub?gid=1531464708&single=true&output=csv"; // placeholder replaced by script
const COLUMN_NAMES = {
  date: "Data",
  unit: "Unidade",
  direct: "Direct Enviado",
  resp: "Respondeu",
  agend: "Agendou",
  comp: "Compareceu",
  buy: "Comprou"
};

let raw = []; // array of records

async function fetchCSV() {
  try {
    const r = await fetch(CSV_URL);
    if(!r.ok) throw new Error('Erro ao buscar CSV: ' + r.status);
    const text = await r.text();
    parseCSV(text);
    render(); // added fix
  } catch(e){ console.error(e); alert('Erro carregando dados: ' + e.message); }
}

function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/).filter(l=>l.trim()!=='');
  if(lines.length<2) { console.warn('CSV sem dados'); return; }
  const rows = [];
  const headers = parseCSVLine(lines[0]);
  for(let i=1;i<lines.length;i++){
    const row = parseCSVLine(lines[i]);
    const obj = {}
    for(let j=0;j<headers.length;j++) obj[headers[j].trim()] = row[j]===undefined ? '' : row[j].trim();
    rows.push(obj);
  }
  raw = rows.reverse(); // latest first
  render();
}

function parseCSVLine(line) {
  const out = []; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch=='"'){ inQ=!inQ; continue; } if(ch==',' && !inQ){ out.push(cur); cur=''; } else cur+=ch; } out.push(cur);
  return out;
}

function sum(list, key) { return list.reduce((s,r)=> s + (Number(r[key])||0), 0); }

function filterByUnit(list, unit) { if(!unit || unit==='Todas') return list; return list.filter(r=> (r[COLUMN_NAMES.unit]||'').trim()===unit); }

function filterByDate(list, from, to) {
  if(!from && !to) return list;
  const f = from ? new Date(from) : new Date('1970-01-01');
  const t = to ? new Date(to) : new Date('2999-01-01');
  return list.filter(r=>{ const d = new Date(r[COLUMN_NAMES.date]); return d>=f && d<=t; });
}

function uniqueUnits(list) { return [...new Set(list.map(r=>r[COLUMN_NAMES.unit]).filter(Boolean))].sort(); }

function render() {
  const sel = document.getElementById('unitSelect');
  const previous = sel.value; // preserve selection

  // populate unit select
  const units = uniqueUnits(raw);
  sel.innerHTML = '<option>Todas</option>' + units.map(u => `<option>${u}</option>`).join('');

  if(previous && [...sel.options].some(o => o.value === previous)) { sel.value = previous; }

  const sel = document.getElementById('unitSelect');
  sel.innerHTML = '<option>Todas</option>' + units.map(u=>`<option>${u}</option>`).join('');
  // apply filters
  const unit = sel.value || 'Todas';
  const from = document.getElementById('from').value;
  const to = document.getElementById('to').value;
  let data = filterByUnit(raw, unit);
  data = filterByDate(data, from, to);
  // KPIs
  document.getElementById('k_direct').textContent = sum(data, COLUMN_NAMES.direct);
  document.getElementById('k_resp').textContent = sum(data, COLUMN_NAMES.resp);
  document.getElementById('k_agend').textContent = sum(data, COLUMN_NAMES.agend);
  document.getElementById('k_comp').textContent = sum(data, COLUMN_NAMES.comp);
  document.getElementById('k_buy').textContent = sum(data, COLUMN_NAMES.buy);
  // table
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';
  for(const r of data.slice(0,500)){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r[COLUMN_NAMES.date]||''}</td><td>${r[COLUMN_NAMES.unit]||''}</td><td>${r[COLUMN_NAMES.direct]||0}</td><td>${r[COLUMN_NAMES.resp]||0}</td><td>${r[COLUMN_NAMES.agend]||0}</td><td>${r[COLUMN_NAMES.comp]||0}</td><td>${r[COLUMN_NAMES.buy]||0}</td>`;
    tbody.appendChild(tr);
  }
  // charts: daily evolution for Directs (group by date)
  const grouped = {}
  for(let i=data.length-1;i>=0;i--){ const r = data[i]; const d = r[COLUMN_NAMES.date]||''; grouped[d] = (grouped[d]||0) + (Number(r[COLUMN_NAMES.direct])||0); }
  const labels = Object.keys(grouped).slice(-30);
  const vals = labels.map(l=>grouped[l]);
  updateLineChart(labels, vals);
  updateFunnelAndPie(data);
  updateForecast(data);
}

// Simple chart helpers
let lineChart, funnelChart, pieChart;
function updateLineChart(labels, vals) {
  const ctx = document.getElementById('evolChart').getContext('2d');
  if(lineChart) lineChart.destroy();
  lineChart = new Chart(ctx, {type:'line', data:{labels:labels, datasets:[{label:'Direct Enviado',data:vals,fill:true,borderColor:'#00b4db',backgroundColor:'rgba(0,180,219,0.12)'}]}, options:{responsive:true,maintainAspectRatio:false}});
}

function updateFunnelAndPie(data) {
  const totalResp = sum(data, COLUMN_NAMES.resp);
  const totalAg = sum(data, COLUMN_NAMES.agend);
  const totalComp = sum(data, COLUMN_NAMES.comp);
  const totalBuy = sum(data, COLUMN_NAMES.buy);
  const fctx = document.getElementById('funnelChart').getContext('2d');
  if(funnelChart) funnelChart.destroy();
  funnelChart = new Chart(fctx, {type:'bar', data:{labels:['Respondeu','Agendou','Compareceu','Comprou'], datasets:[{data:[totalResp,totalAg,totalComp,totalBuy], backgroundColor:['#4bc0c0','#36a2eb','#ff9f40','#9966ff']}]}, options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
  const pctx = document.getElementById('pieChart').getContext('2d');
  if(pieChart) pieChart.destroy();
  pieChart = new Chart(pctx, {type:'doughnut', data:{labels:['Comprou','Não Comprou'], datasets:[{data:[totalBuy, Math.max(0, totalResp-totalBuy)], backgroundColor:['#7b61ff','#2b6f8f']}]}, options:{responsive:true,maintainAspectRatio:false}});
}

function updateForecast(data) {
  const grouped = {}
  for(let i=0;i<data.length;i++){ const d = data[i][COLUMN_NAMES.date]||''; grouped[d] = (grouped[d]||0) + (Number(data[i][COLUMN_NAMES.direct])||0); }
  const days = Object.keys(grouped).slice(-7);
  const avg = days.length ? Math.round(days.reduce((s,d)=>s+grouped[d],0)/days.length) : 0;
  document.getElementById('forecast').textContent = `≈ ${avg} directs por dia (média 7 dias)`;
}

document.getElementById('refreshBtn').addEventListener('click', ()=>fetchCSV());
document.getElementById('unitSelect').addEventListener('change', ()=>render());
document.getElementById('from').addEventListener('change', ()=>render());
document.getElementById('to').addEventListener('change', ()=>render());

// initial load
fetchCSV();
</script>
</body>
</html>
